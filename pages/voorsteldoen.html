<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voorstel voor Presentatie</title>

    <script>


     // before we send our request, this method checks if e mail that we wrote
     // already exist and saves result as an boolean in @let isValid,
     // if exist then we have message that this email is already
     // assigned to an account, otherwise this method will call @addVorsteel() method;
     //
     // @method fetch       gets all people from database
     // @const eMailInput   stores email that we wrote as a string
     // @const people       holds all data from @method fetch
     // @let isValid        is true when program dont find any duplicates in database, and false otherwise

      function checkingIfeMailExist(){
        const eMailInput = document.querySelector("#emailInput").value;
       fetch(`http://localhost:8082/persoon/geefAllePersonen`)
        .then((response)=> response.json())
        .then((data)=>{

          const [...people]= data;
          console.log(data);
          let isValid = true;

          people.forEach(person => {
            isValid = (person.email === eMailInput ? false: true);
            if(!isValid) return;
          })

          if(isValid) addVoorstel();
          else alert("This e mail already exist");
        })
      };







      let huidigEvenement;
      window.onload = function () {
        var evenement = window.location.href.split("=").pop();
        const response = fetch(
          `http://localhost:8082/evenement/geefEvenementPerNaam?e=${evenement}`
        )
          .then((response) => response.json())
          .then((data) => {
            huidigEvenement = data[0];
          });
      };






      const clearValue = function () {
        document.getElementById("nameInput").value = "";
        document.getElementById("surnameInput").value = "";
        document.getElementById("topicInput").value = "";
        document.getElementById("emailInput").value = "";
        document.getElementById("samenInput").value = "";
      };







      async function addVoorstel() {
        const name = document.getElementById("nameInput").value;
        const surname = document.getElementById("surnameInput").value;
        const topic = document.getElementById("topicInput").value;
        const mail = document.getElementById("emailInput").value;
        const samenvat = document.getElementById("samenInput").value;

        const isValid = name && surname && topic && mail && samenvat;

        if (isValid) {
          const request = {
            voornaam: name,
            achternaam: surname,
            onderwerp: topic,
            eMail: mail,
            samenvatting: samenvat,
            veranderd: false,
          };
         
          fetch(
            `http://localhost:8082/evenement/voegVoorstelAanEvenementToe/${huidigEvenement.id}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(request),
            }
          ).then((response) => alert("Voorstel is succesvol verstuurd"));
          console.log(JSON.stringify(request));
          clearValue();
          location.href=`index.html?e=${encodeURI(huidigEvenement.naam)}`;
        }
      }




    </script>
    <link rel="stylesheet" href="../styles/style.css" />
  </head>
  <body>
    <div class="wrapper">
      <div id="form" class="request_window">
        <h1 class="form_title">Stuur je voorstel in!</h1>
        <div class="field">
          <input
            type="text"
            id="nameInput"
            class="input"
            placeholder="Voornaam"
            required
          />
        </div>
        <div class="field">
          <input
            type="text"
            id="surnameInput"
            class="input"
            placeholder="Achternaam"
            required
          />
        </div>
        <div class="field">
          <input
            type="text"
            id="topicInput"
            class="input"
            placeholder="Onderwerp presentatie"
            required
          />
        </div>
        <div class="field">
          <input
            type="email"
            pattern="[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*"
            id="emailInput"
            class="input"
            placeholder="voorbeeld@email.nl"
            required
          />
        </div>
        <div class="field">
          <input
            type="text"
            id="samenInput"
            class="input"
            maxlength="140"
            placeholder="Samenvatting presentatie"
            required
          />
          <label for=""></label>
        </div>
        <button onclick="checkingIfeMailExist()" class="btn">Verstuur</button>
      </div>
    </div>
  </body>
</html>
